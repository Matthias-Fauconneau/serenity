# Defaults: storageFolder=/var/tmp/$TARGET.$ARCH

# --- Source image --- #

# Sources
# Defaults: synthetic=false, if synthetic: source.size = 64
if !synthetic: source name resolution sourceSize physicalSize = Source                                        # Concatenates image slice files in a volume
if  synthetic: source sourceSize = Synthetic                                                                                   # Generates a synthetic pore network

# Denoises
    denoise = '1'
if !denoise: denoised = source
if  denoise: denoised = Median source

# Resamples
if !resample: process-resolution = resolution
if !resample: resampled = denoised
if  resample: resampled mipmap = Resample denoised resolution process-resolution             # Resamples from input resolution to process resolution

# Transposes to use an alternate cylinder axis
if !transpose     : transposed = resampled
if  transpose=='Z': transposed = resampled
if  transpose=='X': transposed = transpose
                                transpose = Transpose resampled
if  transpose=='Y': transposed = Transpose transpose

# --- Pore space --- #

# Density distribution
if !threshold-from-source: histogram-attenuation-full = Histogram resampled
if  threshold-from-source: histogram-attenuation-full = Histogram source
if !ignore-zero-workaround: histogram-attenuation = histogram-attenuation-full
if  ignore-zero-workaround: histogram-attenuation = Slice histogram-attenuation-full begin=1
histogram-attenuation-normalizeX = NormalizeX histogram-attenuation
distribution-attenuation = KernelDensityEstimation histogram-attenuation-normalizeX

# Threshold determination
   threshold =  'otsu'
if threshold == 'otsu'    : threshold otsu-parameters otsu-interclass-deviation = Otsu histogram-attenuation # Statistic recommended method
if threshold == 'gradient': threshold = difference-threshold                                                              # Use this method for backward compatibility only
                                   difference-threshold middle-threshold difference-mean = MaximumMeanGradient source distribution-attenuation-unnormalized
                                                                            distribution-attenuation-unnormalized = KernelDensityEstimation histogram-attenuation normalize=0
if threshold == 'middle'  : threshold = middle-threshold                                     # Selects the middle value between rock and pore attenuation peaks

# Segments
rock = Binary transposed threshold mask=1
pore = Negate rock

# Unconnected pore space volume
histogram-pore = Histogram pore
histogram-pore-slice = Slice histogram-pore begin=1
volume-unconnected = Sum histogram-pore-slice

# Discards unconnected rocks
if !connect-rock: rock-connected = rock
if  connect-rock: rock-connected = FloodFill rock
pore-connect-rock = Negate rock-connected

# Connected pore space volume
histogram-pore-connect-rock = Histogram pore-connect-rock
histogram-pore-connect-rock-slice = Slice histogram-pore-connect-rock begin=1 # Excluding rock
volume-connect-rock = Sum histogram-pore-connect-rock-slice

# --- Curve skeleton --- #

# Computes curve skeleton (thinning)
curve-skeleton = CurveSkeleton pore-connect-rock

# --- Surface skeleton --- #

# Computes position of nearest background voxel
positionx  = PositionX rock-connected
positionxy = PositionY positionx
position   = PositionZ positionxy
distance   = Distance position

# Computes surface skeleton (integer medial axis)
surface-skeleton = SurfaceSkeleton position

# --- Maximum balls --- #

# Discards small pores
    minimalSqRadius = '0'
if  minimalSqRadius: pruned = ThresholdClip surface-skeleton minimalSqRadius
if !minimalSqRadius: pruned = surface-skeleton

# Crops processed volume to remove boundary bias effects (before floodfill to avoid hidden connections)
crop cropSize = Crop pruned

# Floodfills skeleton
unconnected      = Binary crop threshold=1
connected-bottom = FloodFill unconnected minimalSqRadius seed=001000
connected-top    = FloodFill unconnected minimalSqRadius seed=000001
connected-both   = Intersect connected-bottom connected-top

# Discards unconnected pores
    connect-pore = '0'
if !connect-pore          : connected = unconnected
if  connect-pore=='bottom': connected = connected-bottom
if  connect-pore=='top'   : connected = connected-top
if  connect-pore=='1'     : connected = connected-both

# Masks skeleton keeping only unpruned connected voxels
    precomputedSkeleton= '0'
if !precomputedSkeleton: connected-skeleton = Mask connected crop invert=1 value=0
if  precomputedSkeleton: connected-skeleton = ZOrder source

# Rasterizes skeleton voxel as maximum balls
sphere-bins = Bin connected-skeleton connected-skeleton
maximum = Rasterize sphere-bins

# --- Pore size distribution --- #

# Histogram of maximum squared radii
histogram-squaredRadius = Slice histogram-squaredRadius-full begin=1
                                histogram-squaredRadius-full = Histogram maximum

# Square root of radii histogram (As bins are not uniformly spaced anymore, the result cannot be interpreted as a discrete probability density)
histogram-radius = SquareRootVariable histogram-squaredRadius
histogram-radius-scaled = ScaleDistribution histogram-radius process-resolution

# Properties (pore space volume, porosity, mean radius)
volume = volume-connect-pore
         volume-connect-pore = Sum histogram-squaredRadius
porosity = Div volume volume-total # Computes porosity (= pore space volume / total volume )
                      volume-total = Sum histogram-attenuation-full
mean-radius = HistogramMean histogram-radius

# Should be removed (kept for backward compatibility)
 # Normalizes histogram (for comparison with distribution-radius, compare histogram-radius with volume-distribution-radius instead)
 histogram-radius-normalized = Div histogram-radius volume-total
 histogram-radius-normalized-scaled = ScaleDistribution histogram-radius-normalized process-resolution

# Kernel density estimation from radii histogram (i.e. pore size distribution)
volume-distribution-radius = KernelDensityEstimation histogram-radius bandwidth=0.5 normalize=0
# Normalizes probability density on total volume (including background (i.e not the same as probability density normalization (area=porosity))
distribution-radius = Div volume-distribution-radius volume-total
# Normalizes probability density on pore volume (excluding background (i.e probability density normalization (area=1))
distribution-radius-normalized = Div volume-distribution-radius volume

# Scales radius (e.g to original pixel or physical resolution)
 volume-distribution-radius-scaled = ScaleDistribution volume-distribution-radius process-resolution
 distribution-radius-scaled = ScaleDistribution distribution-radius process-resolution
 distribution-radius-scaled-normalized = ScaleDistribution distribution-radius-normalized process-resolution

# --- Pores/throats partitions  --- #

# -- Uniform radius threshold approximation -- #

# Partitions maximum balls between throats and pores using a uniform radius threshold
median-radius = HistogramMedian histogram-radius
approximate-pores = Binary maximum median-radius
not-approximate-pores = Negate approximate-pores
maximum-mask = Binary maximum threshold=1
approximate-throats = Intersect maximum-mask not-approximate-pores # Removes background
approximate-pore-index = FloodFillSplit approximate-pores
approximate-pores = List approximate-pore-index
approximate-colored-pores = ColorizeIndex approximate-pore-index
approximate-colored-pores-throats = Add approximate-colored-pores approximate-throats
approximate-throat-index = FloodFillSplit approximate-throats
approximate-throats = List approximate-throat-index

# -- Curve skeleton method -- #

# Computes connectivity = coordination numbers  = number of edges/neighbours
connectivity = Connectivity curve-skeleton
connectivity-histogram-zero = Histogram connectivity
connectivity-histogram = Slice connectivity-histogram-zero begin=1 # Excluding background

# Distance restricted to curve skeleton voxels
curve-skeleton-distance = Mask curve-skeleton distance invert=1 value=0
curve-skeleton-distance-tiled = ZOrder curve-skeleton-distance

# Local extremum of distance curve
pore-curve-skeleton-extremum-list = LocalExtremumList curve-skeleton-distance
throat-curve-skeleton-extremum-list = LocalExtremumList curve-skeleton-distance minimum=1

# Writes indices (into the pores/throats list) at each pore/throat position
pore-root-index-untiled = RasterizeIndex pore-curve-skeleton-extremum-list cropSize
throat-root-index-untiled = RasterizeIndex throat-curve-skeleton-extremum-list cropSize

pore-root-index = ZOrder pore-root-index-untiled
throat-root-index = ZOrder throat-root-index-untiled

# Rasterizes curve extremum roots as maximum balls (with index attribute) #FIXME TODO: Walk edges to next overlap
pore-root-bins = Bin curve-skeleton-distance-tiled pore-root-index
throat-root-bins = Bin curve-skeleton-distance-tiled throat-root-index
if method == 'curve': pore-index = RasterizeAttribute pore-root-bins
if method == 'curve': throat-index = RasterizeAttribute throat-root-bins
# Lists rasterized voxels for each pore
if method == 'curve': pore-list = List pore-index
if method == 'curve': throat-list = List throat-index

# -- Cluster method -- #
# Defaults: minimum=0

# - Correct inefficient maximum balls cluster method processing full pore space - #
# Generates lists of balls for each radius
maximum-balls-lists = List maximum
# Generates a list of pores from the pore space
if method == 'cluster': last-root-index pore-list = Cluster maximum maximum-balls-lists                # Correct inefficient method
# Writes indices (into the pores list) at each pore position
if method == 'cluster': pore-index = RootIndex pore-list cropSize

# - Incorrect efficient maximum balls cluster method processing from surface skeleton - #
skeleton-balls-lists = List connected-skeleton
last-root-index-skeleton pore-list-skeleton = Cluster maximum skeleton-balls-lists
# Writes root index of each skeleton voxel
pore-skeleton = RootIndex pore-list-skeleton cropSize
# Rasterizes skeleton voxel as maximum balls (with family index attribute)
pore-skeleton-bins = Bin connected-skeleton pore-skeleton
if method == 'cluster-skeleton': pore-index = RasterizeAttribute pore-skeleton-bins
# Lists rasterized voxels for each pore
if method == 'cluster-skeleton': pore-list = List pore-index

# --- Pores/throats analysis --- #

# Colorizes each pore in a different color
colored-pores = ColorizeIndex pore-index
colored-throats = ColorizeIndex throat-index

# Radius of each pore
pore-radius-list = RadiusList pore-list
throat-radius-list = RadiusList throat-list

# Volume of each pore
pore-volume-list = ListSize pore-list
throat-volume-list = ListSize throat-list

# Equivalent radius
pore-equivalent-radius-list = EquivalentRadius pore-volume-list

# (radius, volume) pairs of each pore
pore-radius-volume-list = Pair pore-radius-list pore-volume-list
throat-radius-volume-list = Pair throat-radius-list throat-volume-list

# Bounds pores/throats with bounding boxes
pore-box-list = Bound pore-list
throat-box-list = Bound throat-list                        

# Aspect ratio
pore-aspect-ratio-list = AspectRatio pore-box-list
throat-aspect-ratio-list = AspectRatio throat-box-list
pore-aspect-ratio-distribution = KernelDensityEstimation pore-aspect-ratio-list
throat-aspect-ratio-distribution = KernelDensityEstimation throat-aspect-ratio-list

# Nearest distance
pore-nearest-distance-list = NearestDistance pore-box-list
throat-nearest-distance-list = NearestDistance throat-box-list
pore-nearest-distance-distribution = KernelDensityEstimation pore-nearest-distance-list bandwidth=0.5
throat-nearest-distance-distribution = KernelDensityEstimation throat-nearest-distance-list bandwidth=0.5

# Rasterizes boxes in a volume
pore-box-indices = RasterizeBox pore-box-list cropSize
throat-box-indices = RasterizeBox throat-box-list cropSize

# Colorizes each box in a different color
pore-colored-boxes = ColorizeIndex pore-box-volume
throat-colored-boxes = ColorizeIndex throat-box-volume

# --- Export --- #

sqrt = SquareRoot maximum
sqrt-scaled = ScaleValues sqrt process-resolution
denoised-tiled = ZOrder denoised
denoised-connected = Mask maximum-mask denoised-tiled value=threshold
flood = Add pore maximum-mask
histogram-flood = Histogram flood
not-flood = Negate maximum-mask
pore-not-flood = Intersect pore not-flood

# - PNG - # Exports to PNG (normalized and gamma-compressed for visualization)
png-source = ToPNG source

# - BMP - # Stores unnormalized linear values for interoperation (for 16bit input, discards lowest 8 bits to store only highest 8 bits)
bmp-source = ToBMP source
bmp-denoised = ToBMP denoised
bmp-resampled = ToBMP resampled
bmp-rock = ToBMP rock binary=1

bmp-distance = ToBMP distance
bmp-surface-skeleton = ToBMP surface-skeleton
bmp-connected = ToBMP connected
bmp-maximum = ToBMP maximum
bmp-denoised-connected = ToBMP denoised-connected
bmp-pore-not-flood = ToBMP pore-not-flood binary=1
bmp-maximum-mask = ToBMP maximum-mask binary=1

# - 16bit TIFF - # Stores original (unnormalized and linear) values for interoperation
tiff-denoised = ToTIFF denoised
tiff-denoised-connected = ToTIFF denoised-connected

# - CDL - #
cdl-flood = ToCDL flood
cdl-curve-skeleton = ToCDL curve-skeleton
cdl-surface-skeleton = ToCDL surface-skeleton
cdl-maximum = ToCDL sqrt-scaled
cdl-curve-skeleton-distance = ToCDL curve-skeleton-distance
cdl-connectivity = ToCDL connectivity
cdl-pore-index = ToCDL pore-index
cdl-pore-skeleton = ToCDL pore-skeleton

# - ASCII - #
ascii-flood = ToASCII flood
ascii-maximum = ToASCII sqrt-scaled
ascii-colored-pores = ToASCII colored-pores
ascii = ascii-maximum
