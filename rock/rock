# Rock process definition
# Usage: Specify the path to this process file in order to override the internal definition embedded in the binary
# Syntax: output1 output2 ... = Operator input1 input2 arg1=value ...

# Default arguments
smoothKernelSize = '1'
threshold = 'otsu'
if !cube: cylinder = '' #Clips histograms and slice rendering to the inscribed cylinder

if !validation: source = Source
if validation: source = Capsules

histogram-source = Histogram source
normalized-histogram-source = Normalize histogram-source
density-source = KernelDensityEstimation histogram-source
if threshold == 'otsu': threshold otsu-parameters otsu-interclass-variance = Otsu histogram-source
if threshold == 'otsu': normalized-otsu-interclass-variance = Normalize otsu-interclass-variance #DEBUG: for comparison with histogram-source
if threshold == 'lorentz': threshold lorentz-parameters lorentz-rock lorentz-notrock lorentz-pore lorentz-notpore = LorentzianMixtureModel density-source

shift = ShiftRight source
smoothx = Smooth shift
smoothxy = Smooth smoothx
if !downsample: smooth = Smooth smoothxy shift=0
if downsample: smooth = Downsample source

pore rock = Binary smooth threshold
if !downsample: colorize = Colorize pore source
if downsample: colorize = Colorize pore smooth

# Computes squared distance to / position of nearest background voxel
distancex positionxx = DistanceX pore
distancey positionyx positionyy = DistanceY distancex positionxx
distance positionx positiony positionz = DistanceZ distancey positionyx positionyy

skeleton = Skeleton positionx positiony positionz
unconnected-skeleton = Tile skeleton
connected-skeleton = FloodFill unconnected-skeleton

bin-unconnected = Bin unconnected-skeleton
bin-connected = Bin connected-skeleton
unconnected = Rasterize bin-unconnected
connected = Rasterize bin-connected

# Computes histogram of maximum squared radii
squaredRadius-histogram-unconnected = Histogram unconnected
squaredRadius-histogram-connected = Histogram connected
# Computes pore space volume
volume-unconnected = Sum squaredRadius-histogram-unconnected
volume-connected = Sum squaredRadius-histogram-connected
# Square roots radii
radius-histogram-unconnected = SquareRootVariable squaredRadius-histogram-unconnected
radius-histogram-connected = SquareRootVariable squaredRadius-histogram-connected
# Computes kernel density estimation from radii histogram (i.e. pore size distribution)
radius-distribution-unconnected = KernelDensityEstimation radius-histogram-unconnected
radius-distribution-connected = KernelDensityEstimation radius-histogram-connected
# Scales radius (e.g to original pixel or physical resolution)
scaled-radius-distribution-unconnected = ScaleVariable radius-distribution-unconnected
scaled-radius-distribution-connected = ScaleVariable radius-distribution-connected

#Export
 # Clips to cylinder
 if cylinder: clip-unconnected  = CylinderClip unconnected
 if cylinder: clip-connected = CylinderClip connected

 # Or forwards unclipped volume
 if !cylinder: clip-unconnected = unconnected
 if !cylinder: clip-connected = connected

 # Square roots squared distance
 sqrt-unconnected = SquareRoot clip-unconnected
 sqrt-connected = SquareRoot clip-connected

 # Exports to CDL
 cdl-unconnected = ToCDL sqrt-unconnected
 cdl-connected = ToCDL sqrt-connected

 # Exports to PNG
 png-source = ToPNG source
 png-smooth = ToPNG smooth
 png-colorize = ToPNG colorize
 png-distance = ToPNG distance
 png-skeleton = ToPNG skeleton
 png-unconnected = ToPNG unconnected
 png-connected = ToPNG connected
