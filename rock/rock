# Rock process definition

# Concatenates image slice files in a volume
# \note Parses resolution from input folder name as "name-resolution"
source name resolution voxelSize physicalSize = Source

# Denoises
denoise = 'median'
if !denoise: denoised = source
if denoise == 'average': denoised = average
 shift = ShiftRight source
 averagex = Average shift
 averagexy = Average averagex
 average = Average averagexy shift=0
if denoise == 'median': denoised = median
 median = Median source

# Resamples
if !resample: process-resolution = resolution # Forwards original resolution
if !resample: resampled = denoised # Forwards original volume
if resample: resampled mipmap = Resample denoised resolution process-resolution # Resamples from input resolution to process resolution

# Density distribution
if !thresholdFromSource: histogram-radiodensity = Histogram resampled
if thresholdFromSource: histogram-radiodensity = Histogram source
distribution-radiodensity = KernelDensityEstimation histogram-radiodensity

# Debug
histogram-radiodensity-normalizeY = NormalizeY histogram-radiodensity
distribution-radiodensity-unnormalized = KernelDensityEstimation histogram-radiodensity normalize=0
# Compatibility
histogram-density = histogram-radiodensity
histogram-density-normalized = histogram-radiodensity-normalizeY
distribution-density = distribution-radiodensity-unnormalized

# Threshold determination
threshold = 'otsu'
if threshold == 'otsu': threshold otsu-parameters otsu-interclass-deviation = Otsu histogram-radiodensity # Recommended robust statistic method
otsu-interclass-deviation-normalized = Normalize otsu-interclass-deviation
if threshold == 'gradient': threshold gradient-mean = MaximumMeanGradient source distribution-radiodensity-unnormalized # Use this method for backward compatibility only
if threshold == 'lorentz': threshold lorentz-parameters lorentz-rock lorentz-notrock lorentz-pore lorentz-notpore = LorentzianMixtureModel distribution-radiodensity-unnormalized # Explicit model

# Segments
pore = Binary resampled threshold cylinder=source.cylinder # Also clips to cylinder before distance field evaluation
colorize = Colorize pore resampled # For visualization
thresholded = Threshold resampled threshold # For visualization

# Computes position of nearest background voxel
distancex positionxx = PositionX pore
distancey positionyx positionyy = PositionY distancex positionxx
positionx positiony positionz = PositionZ distancey positionyx positionyy
distance = Distance positionx positiony positionz

# Computes skeleton (medial axis)
skeleton = Skeleton positionx positiony positionz
skeleton-tiled = ZOrder skeleton

# Discards small pores
minimalSqRadius = '0'
if minimalSqRadius: pruned = ThresholdClip skeleton-tiled minimalSqRadius
if !minimalSqRadius: pruned = skeleton-tiled

# Crops processed volume to remove boundary bias effects (before floodfill to avoid hidden connections)
if crop.cylinder: crop = Crop pruned
if !crop.cylinder: crop = pruned

# Transposes to use an alternate connectivity axis (FloodFill always use Z)
transpose = Transpose floodInput
if transpose=='X': transposed = transpose
if transpose=='Y': transposed = Transpose transpose
if transpose=='Z': transposed = floodInput
if !transpose: transposed = floodInput

floodfill = ''
if !floodfill: connected = transposed # Forwards unconnected skeleton
if floodfill: connected = FloodFill transposed minimalSqRadius # Flood fills skeleton

if !floodfillAfterRasterization: floodInput = crop
if !floodfillAfterRasterization: rasterizeInput = connected
if !floodfillAfterRasterization: maximum = rasterized

if floodfillAfterRasterization: rasterizeInput = crop
if floodfillAfterRasterization: floodInput = rasterized
if floodfillAfterRasterization: maximum = connected

# Rasterizes skeleton voxel as maximum spheres
sphere-bins = Bin rasterizeInput
rasterized = Rasterize sphere-bins

# Computes histogram of maximum squared radii
histogram = Histogram maximum # Including rock
histogram-squaredRadius = Slice histogram begin=1 # Excluding rock
# Square roots radii histogram (As bins are not uniformly spaced anymore, the result cannot be interpreted as a discrete probability density)
histogram-radius = SquareRootVariable histogram-squaredRadius
histogram-radius-scaled = ScaleDistribution histogram-radius process-resolution

# Computes notable properties from histogram (pore space volume, total volume, porosity and mean radius)
volume = Sum histogram-squaredRadius
volume-total = Sum histogram
porosity = Div volume volume-total # Computes porosity (= pore space volume / total volume )
mean-radius = HistogramMean histogram-radius

# Should be removed (kept for backward compatibility)
 histogram-radius-normalized = Div histogram-radius volume-total # Normalizes histogram (for comparison with distribution-radius, compare histogram-radius with volume-distribution-radius instead)
 histogram-radius-normalized-scaled = ScaleDistribution histogram-radius-normalized process-resolution

# Computes kernel density estimation from radii histogram (i.e. pore size distribution)
volume-distribution-radius = KernelDensityEstimation histogram-radius bandwidth=0.5 normalize=0
# Normalizes probability density on total volume (including background (i.e not the same as probability density normalization))
distribution-radius = Div volume-distribution-radius volume-total
# Scales radius (e.g to original pixel or physical resolution)
 volume-distribution-radius-scaled = ScaleDistribution volume-distribution-radius process-resolution
 distribution-radius-scaled = ScaleDistribution distribution-radius process-resolution

# Export
 sqrt = SquareRoot maximum
 sqrt-scaled = ScaleValues sqrt process-resolution
 cdl = ToCDL sqrt-scaled
 ascii = ToASCII sqrt-scaled
 # Exports to PNG (normalized and gamma-compressed for visualization)
  png-source = ToPNG source
  png-denoised = ToPNG denoised
  png-colorize = ToPNG colorize
  png-thresholded = ToPNG thresholded
  png-distance = ToPNG distance invert=1
  png-skeleton = ToPNG skeleton invert=1 binary=1
  png-maximum = ToPNG maximum invert=1
# Exports to BMP (Stores original (unnormalized and linear) values for interoperation)
  bmp-source = ToBMP source
  bmp-denoised = ToBMP denoised
  bmp-distance = ToBMP distance
  bmp-skeleton = ToBMP skeleton
  bmp-maximum = ToBMP maximum
  denoised-connected = Mask denoised maximum
  bmp-denoised-connected = ToBMP denoised-connected

# Tools
ε(R) ε(R|r<median) ε(R|r>median) PSD(R) PSD(octant|R:first) PSD(octant|R:inflection) PSD(octant|R:last) representative-radius = REV
critical-radius unconnected(λ) connected(λ) = Prune
slices plots summary = Summary
compare = Compare
