# -- Source -- #

# Sources
    synthetic = '0'
if !synthetic: source name resolution voxelSize physicalSize = Source                                        # Concatenates image slice files in a volume
if  synthetic: source voxelSize = Synthetic                                                                  # Generates a synthetic pore network for debugging and validation

# Denoises
    denoise = '1'
if !denoise: denoised = source
if  denoise: denoised = Median source

# Resamples
if !resample: process-resolution = resolution
if !resample: resampled = denoised
if  resample: resampled mipmap = Resample denoised resolution process-resolution                             # Resamples from input resolution to process resolution

# Transposes to use an alternate cylinder axis
if !transpose     : transposed = resampled
if  transpose=='Z': transposed = resampled
if  transpose=='X': transposed = transpose
                                transpose = Transpose resampled
if  transpose=='Y': transposed = Transpose transpose

# -- Threshold -- #

# Density distribution
if !threshold-from-source: histogram-attenuation-full = Histogram resampled
if  threshold-from-source: histogram-attenuation-full = Histogram source
if !ignore-zero-workaround: histogram-attenuation = histogram-attenuation-full
if  ignore-zero-workaround: histogram-attenuation = Slice histogram-attenuation-full begin=1
histogram-attenuation-normalizeX = NormalizeX histogram-attenuation
distribution-attenuation = KernelDensityEstimation histogram-attenuation-normalizeX

# Threshold determination
   threshold =  'otsu'
if threshold == 'otsu'    : threshold otsu-parameters otsu-interclass-deviation = Otsu histogram-attenuation # Recommended robust statistic method
if threshold == 'gradient': threshold = difference-threshold                                                 # Use this method for backward compatibility only
                                        difference-threshold middle-threshold difference-mean = MaximumMeanGradient source distribution-attenuation-unnormalized
                                         distribution-attenuation-unnormalized = KernelDensityEstimation histogram-attenuation normalize=0
if threshold == 'middle'  : threshold = middle-threshold                                                     # Simply selects the middle value between rock and pore attenuation peaks

# Segments
rock = Binary transposed threshold mask=1
pore = Negate rock

# Unconnected pore space volume
histogram-pore = Histogram pore
histogram-pore-slice = Slice histogram-pore begin=1
volume-unconnected = Sum histogram-pore-slice

# Discards unconnected rocks
if !connect-rock: rock-connected = rock
if  connect-rock: rock-connected = FloodFill rock

# Connected pore space volume
pore-connect-rock = Negate rock-connected
histogram-pore-connect-rock = Histogram pore
histogram-pore-connect-rock-slice = Slice histogram-pore-connect-rock begin=1 # Excluding rock
volume-connect-rock = Sum histogram-pore-connect-rock-slice

# -- Maximum ball -- #

# Computes position of nearest background voxel
positionx  = PositionX rock-connected
positionxy = PositionY positionx
position   = PositionZ positionxy
distance   = Distance position

# Computes surface skeleton (integer medial axis)
surface-skeleton = SurfaceSkeleton position

# Discards small pores
    minimalSqRadius = '0'
if  minimalSqRadius: pruned = ThresholdClip surface-skeleton minimalSqRadius
if !minimalSqRadius: pruned = surface-skeleton

# Crops processed volume to remove boundary bias effects (before floodfill to avoid hidden connections)
crop = Crop pruned

# Floodfills skeleton
unconnected      = Binary crop threshold=1
connected-bottom = FloodFill unconnected minimalSqRadius seed=001000
connected-top    = FloodFill unconnected minimalSqRadius seed=000001
connected-both   = Intersect connected-bottom connected-top

# Discards unconnected pores
    connect-pore = '0'
if !connect-pore          : connected = unconnected
if  connect-pore=='bottom': connected = connected-bottom
if  connect-pore=='top'   : connected = connected-top
if  connect-pore=='1'     : connected = connected-both

# Masks skeleton keeping only unpruned connected voxels
if !precomputedSkeleton: connected-skeleton = Mask connected crop invert=1 value=0
if  precomputedSkeleton: connected-skeleton = ZOrder source

# Rasterizes skeleton voxel as maximum balls
sphere-bins = Bin connected-skeleton connected-skeleton
maximum = Rasterize sphere-bins

# -- Pore size distribution -- #

# Histogram of maximum squared radii
histogram-squaredRadius = Slice histogram-squaredRadius-full begin=1
                                histogram-squaredRadius-full = Histogram maximum

# Square root of radii histogram (As bins are not uniformly spaced anymore, the result cannot be interpreted as a discrete probability density)
histogram-radius = SquareRootVariable histogram-squaredRadius
histogram-radius-scaled = ScaleDistribution histogram-radius process-resolution

# Properties (pore space volume, porosity, mean radius)
volume = volume-connect-pore
         volume-connect-pore = Sum histogram-squaredRadius
porosity = Div volume volume-total # Computes porosity (= pore space volume / total volume )
                      volume-total = Sum histogram
mean-radius = HistogramMean histogram-radius

# Should be removed (kept for backward compatibility)
 histogram-radius-normalized = Div histogram-radius volume-total # Normalizes histogram (for comparison with distribution-radius, compare histogram-radius with volume-distribution-radius instead)
 histogram-radius-normalized-scaled = ScaleDistribution histogram-radius-normalized process-resolution

# Kernel density estimation from radii histogram (i.e. pore size distribution)
volume-distribution-radius = KernelDensityEstimation histogram-radius bandwidth=0.5 normalize=0
# Normalizes probability density on total volume (including background (i.e not the same as probability density normalization (area=porosity))
distribution-radius = Div volume-distribution-radius volume-total
# Normalizes probability density on pore volume (excluding background (i.e probability density normalization (area=1))
distribution-radius-normalized = Div volume-distribution-radius volume
# Scales radius (e.g to original pixel or physical resolution)
 volume-distribution-radius-scaled = ScaleDistribution volume-distribution-radius process-resolution
 distribution-radius-scaled = ScaleDistribution distribution-radius process-resolution
 distribution-radius-scaled-normalized = ScaleDistribution distribution-radius-normalized process-resolution

# -- Throat/pore partition  -- #

# - Approximate throat/pore partition using uniform radius threshold - #

# Partitions maximum balls between throats and pores using a uniform radius threshold
median-radius = HistogramMedian histogram-radius
approximate-pores = Binary maximum median-radius
not-approximate-pores = Negate approximate-pores
maximum-mask = Binary maximum threshold=1
approximate-throats = Intersect maximum-mask not-approximate-pores # Removes background
approximate-pore-index = FloodFillSplit approximate-pores
approximate-colored-pores = ColorizeIndex approximate-pore-index
approximate-colored-pores-throats = Add approximate-colored-pores approximate-throats
approximate-throat-index = FloodFillSplit approximate-throats
#pores = List approximate-pore-index
#throats = List approximate-throat-index

# - Curve Skeleton - #

# Computes curve skeleton (thinning)
curve-skeleton = CurveSkeleton pore-connect-rock

# Computes connectivity = coordination numbers  = number of edges/neighbours
connectivity = Connectivity curve-skeleton
connectivity-histogram-zero = Histogram connectivity
connectivity-histogram = Slice connectivity-histogram-zero begin=1 # Excluding background

# Distance restricted to curve skeleton voxels
curve-skeleton-distance = Mask curve-skeleton distance invert=1 value=0
curve-skeleton-distance-tiled = ZOrder curve-skeleton-distance

# Local extremum of distance curve
#pore-list = LocalExtremumList curve-skeleton-distance
#throat-list = LocalExtremumList curve-skeleton-distance minimum=1

# Writes indices (into the pores/throats list) at each pore/throat position
#pore-indices = RasterizeIndex pore-list voxelSize
#throat-indices = RasterizeIndex throat-list voxelSize

# Rasterizes skeleton voxel as maximum balls (with family index attribute)
#pore-indices-tiled = ZOrder pore-indices
#pore-bins = Bin curve-skeleton-distance-tiled pore-indices-tiled
#throat-indices-tiled = ZOrder throat-indices
#throat-bins = Bin curve-skeleton-distance-tiled throat-indices-tiled
#pore-index = RasterizeAttribute pore-bins
#throat-index = RasterizeAttribute throat-bins

# Colorizes each pore in a different color
#colored-pores = ColorizeIndex pore-index
#colored-throats = ColorizeIndex throat-index

# - Cluster - #

# Generates lists of balls for each radius from the skeleton volume
maximum-balls-lists = List maximum

# Generates a list of pores from the skeleton volume
last-root-index pores throats = Cluster maximum maximum-balls-lists # Inefficient method (runs on all pore space voxels)

# Bounds pores/throats with bounding boxes
pore-bounding-boxes = Bound pores
throat-bounding-boxes = Bound throats

pore-aspect-ratios = AspectRatio pore-bounding-boxes
throat-aspect-ratios = AspectRatio throat-bounding-boxes
pore-aspect-ratio = KernelDensityEstimation pore-aspect-ratios

pore-colored-boxes = ColorizeIndex pore-box-volume
throat-colored-boxes = ColorizeIndex throat-box-volume

# Writes root index (into the family list) of each voxel
pore-skeleton = RootIndex pores voxelSize
throat-skeleton = RootIndex throats voxelSize

# Rasterizes skeleton voxel as maximum balls (with family index attribute)
pore-bins = Bin connected-skeleton pore-skeleton
throat-bins = Bin connected-skeleton throat-skeleton
pore-index = RasterizeAttribute pore-bins
throat-index = RasterizeAttribute throat-bins

# Computes volume of each pore
pore-volume = Histogram pore-index

# Colorizes each pore in a different color
colored-pores = ColorizeIndex pore-index
colored-throats = ColorizeIndex throat-index

pore-aspect-ratios = AspectRatio pore-bounding-boxes
throat-aspect-ratios = AspectRatio throat-bounding-boxes
pore-aspect-ratio = KernelDensityEstimation pore-aspect-ratios
throat-aspect-ratio = KernelDensityEstimation throat-aspect-ratios
pore-nearest-distances = NearestDistance pore-bounding-boxes
throat-nearest-distances = NearestDistance throat-bounding-boxes
pore-nearest-distance = KernelDensityEstimation pore-nearest-distances bandwidth=0.5
throat-nearest-distance = KernelDensityEstimation throat-nearest-distances bandwidth=0.5

# Rasterizes boxes in a volume
pore-box-volume = RasterizeBox pore-bounding-boxes voxelSize
throat-box-volume = RasterizeBox throat-bounding-boxes voxelSize

# Colorizes each box in a different color
pore-colored-boxes = ColorizeIndex pore-box-volume
throat-colored-boxes = ColorizeIndex throat-box-volume

# -- Export -- #

source8 = Normalize8 source
sqrt = SquareRoot maximum
sqrt-scaled = ScaleValues sqrt process-resolution
denoised-tiled = ZOrder denoised
denoised-connected = Mask maximum-mask denoised-tiled value=threshold
flood = Add pore maximum-mask
histogram-flood = Histogram flood
not-flood = Negate maximum-mask
pore-not-flood = Intersect pore not-flood
pore-not-flood8 = Normalize8 pore-not-flood

# - BMP - # (stores original (unnormalized and linear) values for interoperation, quantize 16bit values to 8bit when necessary) [deprecated: use TIFF]
bmp-source = ToBMP source
bmp-denoised = ToBMP denoised
bmp-resampled = ToBMP resampled
bmp-distance = ToBMP distance
bmp-skeleton = ToBMP surface-skeleton
bmp-maximum = ToBMP maximum
bmp-denoised-connected = ToBMP denoised-connected
bmp-pore-not-flood = ToBMP pore-not-flood8
maximum-mask8 = Normalize8 maximum-mask
bmp-maximum-mask = ToBMP maximum-mask8

# - 16bit TIFF - # (Stores original (unnormalized and linear) values for interoperation)
tiff-denoised = ToTIFF denoised
tiff-denoised-connected = ToTIFF denoised-connected

# - CDL - #
cdl-flood = ToCDL flood
cdl-maximum = ToCDL sqrt-scaled
cdl-pore-index = ToCDL pore-index
cdl = cdl-maximum

# - ASCII - #
ascii-flood = ToASCII flood
ascii-maximum = ToASCII sqrt-scaled
ascii-colored-pores = ToASCII colored-pores
ascii = ascii-maximum
