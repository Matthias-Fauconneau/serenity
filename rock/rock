# Rock process definition
# Usage: Specify the path to this process file in order to override the internal definition embedded in the binary
# Syntax: output1 output2 ... = Operator input1 input2 arg1=value arg2 ...

# Parse physical resolutions (i.e inverse sample rate)
resolution = '1'
if resolution == 'auto': resolution = PhysicalResolution # Parses resolution from input folder name as "name-resolution"
resolutions = resolution path # Parses all resolutions (using sweep generator)

# Use largest possible box fitting all inputs (box=auto)
if box == 'auto': integer-box = Round input-box # Rounds input-box to nearest integer for Source
 input-box = Div common-box resolution # Converts physical common box to pixels (using current input resolution)
 common-box = CommonSampleSize resolutions # Returns largest possible box fitting all inputs

# Imports volume data from image slices
if box == 'auto': source = Source integer-box
if box != 'auto': source = Source

# Denoises
denoise = 'median'
if !denoise: denoised = source
if denoise == 'average': denoised = average
 shift = ShiftRight source
 averagex = Average shift
 averagexy = Average averagex
 average = Average averagexy shift='0'
if denoise == 'median': denoised = median
 median = Median source

# Resamples all volumes to coarsest resolution
common-resolution = Maximum resolutions
if resample: resampled mipmap = Resample denoised resolution common-resolution # Resamples from input resolution to common-resolution
if resample: resampled-resolution = common-resolution # Forwards common resolution
if !resample: resampled = denoised # Forwards original volume
if !resample: resampled-resolution = resolution # Forwards original resolution
# Density distribution
if !box: cylinder = '' #Clips histograms to the inscribed cylinder
if !thresholdFromSource: histogram-density = Histogram resampled
if thresholdFromSource: histogram-density = Histogram source
histogram-density-normalized = Normalize histogram-density
distribution-density = KernelDensityEstimation histogram-density

# Threshold determination
threshold = 'otsu'
if threshold == 'otsu': threshold otsu-parameters otsu-interclass-deviation = Otsu histogram-density # Recommended robust statistic method
otsu-interclass-deviation-normalized = Normalize otsu-interclass-deviation
if threshold == 'gradient': threshold gradient-mean = MaximumMeanGradient source distribution-density # Use this method for backward compatibility only
if threshold == 'lorentz': threshold lorentz-parameters lorentz-rock lorentz-notrock lorentz-pore lorentz-notpore = LorentzianMixtureModel distribution-density # Explicit model

pore = Binary resampled threshold # Also clips to cylinder
if !downsample: colorize = Colorize pore source
if downsample: colorize = Colorize pore resampled

# Computes squared distance to / position of nearest background voxel
distancex positionxx = DistanceX pore
distancey positionyx positionyy = DistanceY distancex positionxx
distance positionx positiony positionz = DistanceZ distancey positionyx positionyy

skeleton = Skeleton positionx positiony positionz
skeleton-tiled = ZOrder skeleton

# Rasterizes clipped skeleton
sphere-bins = Bin skeleton-tiled
rasterized = Rasterize sphere-bins

# Transposes to use an alternate connectivity axis (FloodFill always use Z)
transposed = Transpose rasterized
if transpose=='X': unconnected = transposed
if transpose=='Y': unconnected = Transpose transposed
if transpose=='Z': unconnected = rasterized
if !transpose: unconnected = rasterized

# Flood fills pore space (same as pruned-unconnected{minimalRadius=0}
connected = FloodFill unconnected

# Discards small and unconnected pores
if !sweep: minimalRadius = '0'
if sweep: minimalRadius = {0..15}
minimalSqRadius = $minimalRadius^2
pruned-unconnected = ThresholdClip unconnected minimalSqRadius
pruned-connected = FloodFill pruned-unconnected # Flood fills pruned pore space

# Crops result to remove boundary bias
#TODO

# Computes histogram of maximum squared radii
histogram-squaredRadius-unconnected = Histogram pruned-unconnected
histogram-squaredRadius-connected = Histogram pruned-connected
# Computes pore space volume
volume-unconnected = Sum histogram-squaredRadius-unconnected
volume-connected = Sum histogram-squaredRadius-connected
# Computes total volume (including rock)
histogram-total = Histogram unconnected clip='0'
volume-total = Sum histogram-total
# Computes porosity (= pore space volume / total volume )
porosity-unconnected = Div volume-unconnected volume-total
porosity-connected = Div volume-connected volume-total

# Unconnected Volume( minimalSqRadius) sweep #FIXME: accumulate histogram-squaredRadius-unconnected
volume-unconnected-minimalSqRadius = volume-unconnected minimalSqRadius
volume-unconnected-minimalRadius = SquareRootVariable volume-unconnected-minimalSqRadius
porosity-unconnected-minimalRadius = Div volume-unconnected-minimalRadius volume-total

# Connected Volume( minimalSqRadius) sweep
volume-connected-minimalSqRadius = volume-connected minimalSqRadius
volume-connected-minimalRadius = SquareRootVariable volume-connected-minimalSqRadius
porosity-connected-minimalRadius = Div volume-connected-minimalRadius volume-total

# Returns the maximum pruning radius with volume > 0 (connectivity)
maximum-minimalRadius = Optimize volume-connected-minimalRadius criteria='maximumArgument' constraint='>0'

# Square roots radii histogram (As bins are not uniformly spaced anymore, the result cannot be interpreted as a discrete probability density)
histogram-radius-unconnected = SquareRootVariable histogram-squaredRadius-unconnected
histogram-radius-connected = SquareRootVariable histogram-squaredRadius-connected
# Computes kernel density estimation from radii histogram (i.e. pore size distribution)
volume-distribution-radius-unconnected = KernelDensityEstimation histogram-radius-unconnected bandwidth='0.5'
volume-distribution-radius-connected = KernelDensityEstimation histogram-radius-connected bandwidth='0.5'
# Normalize probability density on total volume (including background (i.e not the same as density normalization))
distribution-radius-unconnected = Div volume-distribution-radius-unconnected volume-total
distribution-radius-connected = Div volume-distribution-radius-connected volume-total

# Scales radius (e.g to original pixel or physical resolution)
 distribution-radius-unconnected-scaled = ScaleVariable distribution-radius-unconnected resampled-resolution
 distribution-radius-connected-scaled = ScaleVariable distribution-radius-connected resampled-resolution
 porosity-unconnected-minimalRadius-scaled = ScaleVariable porosity-unconnected-minimalRadius resampled-resolution
 porosity-connected-minimalRadius-scaled = ScaleVariable porosity-connected-minimalRadius resampled-resolution

# Representative elementary volume estimation
 # Sweeps cylinderRadius computing connected size distributions and porosity
  distribution-radius-connected-cylinderRadius = distribution-radius-connected cylinder
  porosity-connected-cylinderRadius = porosity-connected cylinder
  porosity-connected-cylinderRadius-scaled = ScaleVariable porosity-connected-cylinderRadius resampled-resolution

 # Pore size distribution error
  # Assumes last distribution is correct
  distribution-radius-connected-correct = Last distribution-radius-connected-cylinderRadius #[-1]
  # Computes relative errors
  distribution-radius-connected-error = AbsoluteDifference distribution-radius-connected distribution-radius-connected-correct

 # Porosity error
  # Computes relative errors (assuming last value is correct)
  porosity-error = RelativeError porosity-connected-cylinderRadius-scaled
  # Smoothes relative errors
  porosity-error-smooth = RunningAverage porosity-error
  # Returns the minimum cylinderRadius with error < 5%
  minimum-cylinderRadius = Optimize porosity-error-smooth criteria='minimumArgument' constraint='<0.05'

# Square roots squared distance
 sqrt-unconnected = SquareRoot pruned-unconnected
 sqrt-connected = SquareRoot pruned-connected

# Scale volume values
 sqrt-unconnected-scaled = ScaleValues sqrt-unconnected resampled-resolution
 sqrt-connected-scaled = ScaleValues sqrt-connected resampled-resolution

# Exports to CDL
 cdl-unconnected = ToCDL sqrt-unconnected
 cdl-connected = ToCDL sqrt-connected

# Exports to ASCII
 ascii-unconnected = ToASCII sqrt-unconnected
 ascii-connected = ToASCII sqrt-connected

# Exports to PNG
 png-source = ToPNG source
 png-denoised = ToPNG denoised
 png-colorize = ToPNG colorize
 png-distance = ToPNG distance
 png-skeleton = ToPNG skeleton
 png-unconnected = ToPNG unconnected
 png-connected = ToPNG connected
