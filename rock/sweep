# Rock sweep definitions

# Computes largest possible box fitting all inputs
resolution-path = $resolution{path}
common-box = CommonSampleSize resolution-path # Returns largest possible box fitting all inputs
input-box = Div common-box $resolution # Converts physical common box to pixels (using current input resolution)
box = Round input-box # Rounds input-box to nearest integer for Source

# Volume versus minimalRadius sweep
minimalSqRadius = minimalRadius^2
volume-minimalSqRadius = $volume{minimalSqRadius}
volume-minimalRadius = SquareRootVariable
porosity-minimalRadius = Div volume-minimalRadius $volume-crop
porosity-minimalRadius-scaled = ScaleVariable porosity-minimalRadius $process-resolution
# Maximum pruning radius with volume > 0 (connectivity)
maximum-minimalRadius = Optimize volume-minimalRadius criteria='maximumArgument' constraint='>0'

# Representative elementary volume (REV) estimation
  volume-distribution-radius-crop = $volume-distribution-radius{crop.cylinder}
  distribution-radius-crop = $distribution-radius{crop.cylinder}
  distribution-radius-crop-scaled[] = ScaleDistribution distribution-radius-crop[] $process-resolution
  porosity-crop = $porosity{crop.cylinder}
  porosity-crop-scaled = ScaleVariable porosity-crop $process-resolution

 # Pore size distribution error to last (for REV with increasingly large volumes)
  distribution-radius-crop-error-last = DistributionError volume-distribution-radius-crop reference='last'
  distribution-radius-crop-error-last-scaled = ScaleVariable distribution-radius-crop-error-last process-resolution
  # Returns the minimum crop radius with distribution error < 10%
  minimum-crop-distribution = Optimize distribution-radius-crop-error-last-scaled slice='0-1' criteria='minimumArgument' constraint='<0.20'

 # Pore size distribution deviation (TODO: automatically compute 8 sample crop parameters from sweep size)
  distribution-radius-crop-deviations = DistributionError distribution-radius-crop reference='mean'
  distribution-radius-crop-deviation-mean = Deviation distribution-radius-crop-deviations

 # Porosity error
  # Computes relative errors (assuming last value is correct)
  porosity-error-crop = ScalarError porosity-crop
  porosity-error-crop-scaled = ScaleVariable porosity-error-crop process-resolution
  # Returns the minimum cropRadius with porosity error < 10%
  minimum-crop-porosity = Optimize porosity-error-crop-scaled criteria='minimumArgument' constraint='<0.05'
